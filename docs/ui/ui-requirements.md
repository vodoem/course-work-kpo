# UI requirements — Avalonia (CosmicCollector)

Этот документ — **source of truth** для реализации UI на Avalonia (ветка `ui-avalonia`).
UI должен соответствовать макетам из ТЗ: экраны, навигация, состав элементов и поведение.

## 0. Общие ограничения
- .NET 8.0, Avalonia UI.
- MVC: View = XAML/отрисовка/ввод, Controller = обработка ввода/навигация, игра/логика = Core/MVC/Persistence.
- UI **не** считает коллизии/очки/спавн/таймеры сам.
- Взаимодействие с движком только через:
  - события EventBus (подписка),
  - команды через CommandQueue (отправка),
  - чтение данных только из Snapshot (GameSnapshot и вложенные).
- Запрещены таймеры Avalonia/Task.Delay/System.Timers/... (см. AGENTS.md). Обновление UI по событию GameTick + Dispatcher-перенос на UI-thread.

## 1. Навигация и экраны (обязательные)
Экранов ровно 5 (как в ТЗ):
1) Главное меню
2) Правила
3) Рекорды
4) Игра
5) Экран окончания (Game Over / Level Completed + сохранение рекорда)

Навигация:
- Из главного меню: Играть / Рекорды / Правила / Выход
- Из Правил и Рекордов: кнопка/клавиша “Назад” → Главное меню
- Из Игры: Пауза → меню паузы (Продолжить / Выйти в меню с подтверждением Y/N или кнопками)
- Из Экрана окончания: Сохранить (если рекорд) / Заново / В меню

## 2. Управление (клавиши)
- В игре:
  - A/D или Left/Right: движение влево/вправо (удержание = непрерывное движение, отпускание = стоп)
  - P: пауза (toggle)
- В паузе:
  - Навигация по пунктам (стрелки/Tab) + Enter
  - Подтверждение выхода: отдельный диалог (Да/Нет) или клавиши Y/N
- В меню/списках:
  - Up/Down, Enter
  - Esc = Назад (для Правил/Рекордов/паузы)

Важно: UI не “компенсирует” дезориентацию. UI всегда отправляет команды направления, а движок решает как их интерпретировать.

## 3. Игровой экран (состав и расположение)
### 3.1 Поле
- Центр экрана занимает игровое поле (рамка/границы).
- Дрон визуально внизу по центру при старте.
- Объекты падают сверху вниз.
- Отрисовка объектов: **спрайты (PNG)**.

### 3.2 HUD (как в макете)
HUD всегда видим поверх/над полем, без мерцания:
- Строка/зона 1:
  - Слева: **Цель очков** (target score) — реальное число
  - Центр: значение таймера уровня (без слова “Таймер”)
  - Справа: Уровень, Энергия, Очки
- Строка/зона 2:
  - Справа: **Прогресс по кристаллам** в формате:
    - B: collected/required, G: collected/required, R: collected/required
  - Никаких “сколько объектов на поле”, “сколько бонусов” и прочей телеметрии.

Источники данных только из `GameSnapshot` + `LevelGoalsSnapshot/LevelProgressSnapshot`.

## 4. Пауза
- При нажатии P показывается overlay/панель “ПАУЗА” + меню:
  - Продолжить
  - Выйти в главное меню
- При выборе “Выйти в главное меню” показывается подтверждение:
  - “Прогресс не сохранится. Выйти?” [Да/Нет]
- Во время паузы:
  - таймер уровня **не уменьшается**
  - игровой мир **не обновляется** (движок должен уже это обеспечивать)
- При снятии паузы:
  - показывается countdown 3..1 (если по ТЗ так задумано) и только потом игра продолжается

## 5. Экран окончания игры / сохранение рекорда
- Два сценария:
  - GameOver: проигрыш (энергия = 0 или время = 0)
  - LevelCompleted: уровень пройден (если переход на следующий уровень — это не экран окончания; экран окончания только при завершении всей игры)
- Экран показывает:
  - итог: уровень, очки, причина окончания (если есть)
  - если это рекорд: поле ввода имени + кнопка Сохранить
  - кнопки: Заново / В меню

## 6. Спрайты (PNG) и заглушки
### 6.1 Папка ассетов
UI ожидает ассеты в:
- `CosmicCollector.Avalonia/Assets/Sprites/`

### 6.2 Имена файлов (контракт)
(позже вы замените на “настоящие” картинки, UI не должен сломаться)
- drone.png
- crystal_blue.png
- crystal_green.png
- crystal_red.png
- asteroid.png
- bonus_magnet.png
- bonus_accelerator.png
- bonus_time.png
- blackhole.png

### 6.3 Заглушки
Если PNG отсутствует, UI обязан отображать **fallback**:
- цветной прямоугольник/иконка + короткая метка (например “B”, “G”, “R”, “A”, “M”, “T”, “BH”, “D”).
Это нужно, чтобы проект собирался и работал без картинок.

## 7. Интеграция с движком (контракт)
UI подписывается на события:
- GameTick (обновление кадра)
- PauseToggled
- CountdownTick
- GameOver
- LevelCompleted
- RecordsUpdated (для экранов рекордов)

UI отправляет команды:
- SetMoveDirectionCommand / MoveLeft / MoveRight (как сейчас в проекте)
- TogglePauseCommand
- команды навигации UI не уходят в Core (только внутри Avalonia слоя)

UI читает:
- GameSnapshot (позиции/объекты/очки/энергия/таймер/уровень/цели/прогресс)

## 8. Definition of Done для ветки ui-avalonia (минимум)
- Проект `CosmicCollector.Avalonia` добавлен в solution и собирается.
- Все 5 экранов реализованы и связаны навигацией.
- Игра запускается из меню, рендерится по GameTick.
- Управление, пауза, подтверждение выхода, экран окончания и сохранение рекорда работают.
- UI работает без PNG (fallback рисуется).
