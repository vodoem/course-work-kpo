# AGENTS.md — Guardrails for Codex (Cosmic Collector)

Этот файл задаёт **обязательные правила** для Codex/агента при работе в репозитории.
Он специально короткий: всё подробное описание — в `docs/**`.

## Source of truth (читать в первую очередь)
Агент **обязан** ориентироваться на следующие файлы (в указанном порядке приоритетов):
1) `docs/spec/requirements.md`
2) `docs/spec/acceptance_checklist.md`
3) `docs/architecture/solution_structure.md`
4) `docs/architecture/threading.md`
5) `docs/architecture/events.md`
6) `docs/ui/avalonia/ui-requirements.md` (требования к UI Avalonia)
7) `docs/spec/csharp_style_summary.md`
8) `docs/codex/prompt_cookbook.md`

Если есть конфликт — решаем в пользу пунктов 1–2.

## Непереговорные ограничения (нельзя нарушать)
- **.NET: net8.0**
- **2 UI**: Console + **Avalonia**.
- **MVC обязательно**: UI = View (отрисовка/ввод), бизнес-логика = Controller/Core.
- **Общая логика в библиотеках**: Core/MVC/Persistence не содержат UI-специфичного кода.
- **События**: взаимодействие компонентов через собственные события (см. `docs/architecture/events.md`).
- **Многопоточность и синхронизация обязательны** (см. `docs/architecture/threading.md`).
- **Таймеры запрещены**:
  - нельзя `DispatcherTimer`, `System.Timers.Timer`, `System.Threading.Timer` и аналоги;
  - частоту тиков поддерживать через game loop + `Stopwatch` + ожидание остатка (`Thread.Sleep`/экв.).
- **UI не содержит логики игры**:
  - запрещены расчёты коллизий, начисление очков, изменение модели мира напрямую в UI;
  - UI только отправляет команды и отображает snapshot состояния.
- **Паттерны**: минимум 2 паттерна сверх MVC (рекомендуемые: Observer + Command/Factory).
- **Тесты**: выбрать 1 класс и сделать ≥ 20 unit-тестов (см. `docs/testing/unit_tests_target.md`).

## Правила внесения изменений
- Делай изменения **минимальным диффом**, без “рефакторинга заодно”.
- 1 задача = 1 логический шаг. Если большой объём — сначала план, затем шаги M1/M2/…
- Не меняй публичные контракты без необходимости. Если меняешь — обязательно обнови места использования и тесты.
- Следуй стилю C# из `docs/spec/csharp_style_summary.md` (1 тип на файл, XML docs, нейминг и т.д.).

## Definition of Done для любой задачи
Перед тем как считать задачу выполненной, агент обязан:
- запустить `dotnet build` и убедиться, что сборка проходит;
- запустить `dotnet test` и убедиться, что тесты проходят;
- убедиться, что чек-лист `docs/spec/acceptance_checklist.md` не нарушен;
- проверить, что в изменениях не появились запрещённые таймеры.

## Коммуникация (как отвечать в PR/чате)
В ответе всегда указывать:
- что изменено (1–6 пунктов),
- какие файлы затронуты,
- как проверить (команды),
- какие ограничения из `docs/**` учтены (коротко).

Все ответы/summary/планы — на русском языке.